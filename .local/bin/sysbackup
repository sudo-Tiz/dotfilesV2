#!/bin/sh
LUKS_PART="/dev/sda2"
MOUNT_POINT="/mnt/backup"
SOURCE="/"

[ "$(id -u)" -eq 0 ] || {
  echo "Error: run as root"
  exit 1
}

[ -e /dev/mapper/backup ] || cryptsetup open "$LUKS_PART" backup -d - ||
  {
    echo "Error: cannot open $LUKS_PART"
    exit 1
  }

mountpoint -q "$MOUNT_POINT" 2>/dev/null || (
  mkdir -p "$MOUNT_POINT"
  mount /dev/mapper/backup "$MOUNT_POINT" ||
    {
      echo "Error: cannot mount /dev/mapper/backup"
      cryptsetup close backup
      exit 1
    }
)

rsync -aAXx --info=progress2 --info=name0 --stats --delete \
  --exclude="/dev/*" \
  --exclude="/proc/*" \
  --exclude="/sys/*" \
  --exclude="/tmp/*" \
  --exclude="/var/tmp/*" \
  --exclude="/var/cache/*" \
  --exclude="/run/*" \
  --exclude="/lost+found/*" \
  --exclude="/media/*" \
  --exclude="/swapfile" \
  --exclude="*.log" \
  --exclude="*.tmp" \
  --exclude="*.swp" \
  --exclude="*.bak" \
  --exclude="*.cache" \
  --exclude="*.thumbnails" \
  --exclude="*.old" \
  --exclude="/mnt/*" \
  --exclude="/var/lib/docker/*" \
  --exclude="/var/cache/pacman/pkg/*" \
  --exclude="/var/log/journal/*" \
  --exclude="/home/*/.cache/*" \
  --exclude="/home/*/.mozilla/firefox/*/cache2/*" \
  --exclude="*.core" \
  --exclude="*.pid" \
  --exclude="*.sock" \
  --exclude="/home/tiz/cloud/*" \
  --exclude="/home/tiz/documents/*" \
  --exclude="/home/tiz/images/*" \
  --exclude="/home/tiz/notes/*" \
  --exclude="/home/tiz/muzek/*" \
  --exclude="/home/*/Downloads/*" \
  "$SOURCE" "$MOUNT_POINT"
RET=$?

MSG="Backup $([ $RET -eq 0 ] && echo completed || echo failed)"
if command -v notify-send >/dev/null 2>&1; then
  sudo -u tiz DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/1000/bus \
    notify-send "LUKS Backup" "$MSG" || echo "$MSG"
else
  echo "$MSG"
fi

printf "Unmount and close LUKS container now? [y/N] "
read ANS
case "$ANS" in
[Yy]*) umount "$MOUNT_POINT" && cryptsetup close backup || echo "Warning: cleanup failed" ;;
*) echo "Container left mounted" ;;
esac
